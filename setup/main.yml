---
- hosts: localhost 
  remote_user: root
  tasks:
    - name: pip install
      apt:
        name: python-pip
    - name: psycopg2 prereq (libpq-dev)
      apt:
        name: libpq-dev
    - name: psycopg2 install
      apt:
        name: python-psycopg2
    - name: postgresql install
      apt:
        name: postgresql
        state: latest
    - name: postgresql activate
      service:
        name: postgresql
        state: started

    - name: virtualenv install
      apt:
        name: virtualenv

    - name: install Python libs
      pip:
        requirements: "{{ playbook_dir }}/requirements.txt"
        virtualenv: "{{ playbook_dir }}/../venv"
        virtualenv_python: python3

    - name: postgresql database (scriter_ingest)
      become: true
      become_user: postgres
      postgresql_db: 
        name: scriter_ingest
    - name: postgresql database (scriter_web)
      become: true
      become_user: postgres
      postgresql_db:
        name: scriter_web
    - name: postgresql service account ingest
      become: true
      become_user: postgres
      postgresql_user:
        db: scriter_ingest
        name: scriter_user
        password: scriter_pass
        priv: "ALL"
        encrypted: yes
    - name: postgresql service account web
      become: true
      become_user: postgres
      postgresql_user:
        db: scriter_web
        name: scriter_user
        password: scriter_pass
        priv: "ALL"
        encrypted: yes

    - name: apache install
      apt:
        name: apache2
        state: latest
    - name: apache activate
      service:
        name: apache2
        state: started

    - name: add service account
      user: 
        name: scriter
    - name: change directory ownership
      file:
        name: "{{ playbook_dir }}/.."
        owner: scriter
        group: scriter
        recurse: yes
